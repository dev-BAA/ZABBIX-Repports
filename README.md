# Zabbix: отчет печати на МФУ в организации

Часто в организации требуется получать отчет о печати, сколько страниц было напечатано на каждом МФУ за месяц или год.

Zabbix сервер не имеет механизма создания очетов, однако у Zabbix есть API интерфейс. И данный отчет можно генерировать с помощью Python и Zabbix API (https://www.zabbix.com/documentation/current/ru/manual/api) с последующим импортом данных в Excel таблицу. Предварительно собрав данные в Zabbix с МФУ с помощью snmp.

![Отчет печати на МФУ](https://github.com/dev-BAA/ZABBIX-Repports/blob/master/img.png)

## Настройки ОС

- ОС сервера **Centos7**
- В ОС установлены следующие пакеты:
  - **python**
  - **openpyxl** (модуль для работы с Excel таблицами)
  - **pyzabbix** (модуль для работы с API Zabbix, https://github.com/lukecyca/pyzabbix)
- Для выгрузки данных в Excel, к ОС Zabbix сервера примонтирована сетевая папка.

## Настройки Zabbix

- Zabbix сервер установлен в типовой конфигурации
- Созданы шаблоны и группы по производителям МФУ:
  - Принтеры Canon
  - Принтеры Kyocera
  - Принтеры HP
  - и т.д.
- Создана учетная запись для Zabbix API

#### В Zabbix настроено Низкоуровневое обнаружение

- Диапазон IP адресов:
  - указаны подсети которым принадлежат ip адреса МФУ
- Проверки:
  - SNMPv1 агент **1.3.6.1.2.1.2.2.1.6.1**    ifPhysAddress, MAC адрес сетевого интерфейса
  - SNMPv1 агент **1.3.6.1.2.1.25.3.2.1.3.1** DeviceDescr, модель устройства "HP LaserJet P2055dn"
- Критерий уникальности устройства:
  - SNMPv1 агент **1.3.6.1.2.1.2.2.1.6.1**    лучше использовать MAC адрес, так как ip адрес у МФУ может меняться, например при смене подсети

#### В Zabbix настроено Действие для каждого производителя МФУ

- Тип вычисления:
  - A and B and C
- Условия:
  - A - Правило обнаружения равно Принтеры в сетях x.x.x.x
  - B - Полученное значение содержит Canon
  - C - Состояние обнаружения равно Доступен
- Операции:
  - Добавить узел сети
  - Добавить в группы узлов сети: Принтеры Canon
  - Присоединить к шаблонам: Принтеры Canon

#### Настройки шаблонов по производителям МФУ на примере шаблона Canon

Элементы данных:

- Для всех элемнтов:
  - История значений хранится - 90 дней
  - Тип интерфейса            - SNMPv1 агент

- Для элемента MAC адрес:
  - ключ - MAC
  - SNMP OID - 1.3.6.1.2.1.2.2.1.6.1
  - Интервал обновления - 1 день
- Для элемента Имя:
  - ключ - sysName
  - SNMP OID - 1.3.6.1.2.1.1.5.0
  - Интервал обновления - 2 часа
- Для элемента Местоположение:
  - ключ - sysLocation
  - SNMP OID - 1.3.6.1.2.1.1.6.0
  - Интервал обновления - 2 часа
- Для элемента Модель:
  - ключ - ModelName
  - SNMP OID - 1.3.6.1.2.1.25.3.2.1.3.1
  - Интервал обновления - 1 день
- Для элемента Отпечатано страниц:
  - ключ - PageCounter
  - SNMP OID - 1.3.6.1.2.1.43.10.2.1.4.1.1
  - Интервал обновления - 1 час

## Настройки на МФУ
- должен быть включен **snmp.v1**
- указать **sysName**, в необходимом формате, напр. M0001
- указать **sysLocation**, в необходимом формате, напр. BC1001 (BC - бизнес центр, 1001 - кабинет)
- на некоторых МФУ параметры **sysName** и **sysLocation** не всегда вынесены в web интерфейс, в этих случаях пригодятся HP JetAdmin и Kyocera Net Viewer

## Отчет prin.xslx и скрипты автоматизации

- В репозитории 3 скрипта Python:
  - **z_new_host.py** - переименовывает добавленные, низкоуровневым обнаружением, МФУ, в соответствии с их именем **sysName**, заданным в настройках на МФУ
  - **z_update_group_host.py** - обновляет группы и шаблоны хоста в соответствии с маркой МФУ
  - **z_hist.py** - забирает исторические данные (Местоположение, Имя принтера, MAC, Количество напечатанных страниц за заданный период) с СУБД подключенной к Zabbix, записывает их в файл **prin.xslx**, расположенный в сетевой папке
- Запуск скриптов производится раз в сутки из **cron**, или можно реализовать как сервис **systemd**